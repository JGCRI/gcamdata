<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>XML Conversion • gcamdata</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../../bootstrap-toc.css">
<script src="../../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><meta property="og:title" content="XML Conversion">
<meta property="og:description" content="gcamdata">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">gcamdata</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">5.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="../../articles/getting-started/getting-started.html">Getting Started</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/driverdrake_vignette.html">driver_drake</a>
    </li>
    <li>
      <a href="../../articles/usermod_vignette.html">User Modification Functions</a>
    </li>
  </ul>
</li>
<li>
  <a href="../../reference/index.html">
    <span class="fa fa-file-code-o"></span>
     
    Reference
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/JGCRI/gcamdata/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="xml_conversion_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>XML Conversion</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/JGCRI/gcamdata/blob/HEAD/vignettes/changing-the-data-system/xml_conversion.Rmd" class="external-link"><code>vignettes/changing-the-data-system/xml_conversion.Rmd</code></a></small>
      <div class="hidden name"><code>xml_conversion.Rmd</code></div>

    </div>

    
    
<p>As the gcamdata pacakge builds all of the data needed to run GCAM as the last step we will need to generate XML files that GCAM expects as it’s input files. This article describes the basics of writing a chunk that creates an XML file and a guide to create a new “header” to convert a table to XML syntax that does not already exist in the library.</p>
<div class="section level2">
<h2 id="writing-a-batch-xml-chunk">Writing a batch XML chunk<a class="anchor" aria-label="anchor" href="#writing-a-batch-xml-chunk"></a>
</h2>
<p>As noted above a batch XML chunk will declare as inputs L200-chunk outputs that need to get converted to XML. It would declare as output an “XML” object corresponding to the GCAM XML input file it generates. Generally each batch chunk generates just one XML but this isn’t enforced and users are free to generate more than one if it makes sense to do so (such as creating a XML files by looping over each scenario).</p>
<p>From here a user would simply add each tibble in using the XML pipeline helpers defined in <code>xml.R</code>:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load required inputs</span></span>
<span><span class="va">L200.ModelTime</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/get_data.html">get_data</a></span><span class="op">(</span><span class="va">all_data</span>, <span class="st">"L200.ModelTime"</span><span class="op">)</span></span>
<span><span class="va">L200.ModelTimeInterYears</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/get_data.html">get_data</a></span><span class="op">(</span><span class="va">all_data</span>, <span class="st">"L200.ModelTimeInterYears"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Produce outputs</span></span>
<span><span class="fu"><a href="../../reference/create_xml.html">create_xml</a></span><span class="op">(</span><span class="st">"modeltime.xml"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span><span class="fu"><a href="../../reference/add_xml_data.html">add_xml_data</a></span><span class="op">(</span><span class="va">L200.ModelTime</span>, <span class="st">"ModelTime"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span><span class="fu"><a href="../../reference/add_xml_data.html">add_xml_data</a></span><span class="op">(</span><span class="va">L200.ModelTimeInterYears</span>, <span class="st">"ModelTimeInterYears"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span><span class="fu"><a href="../../reference/add_precursors.html">add_precursors</a></span><span class="op">(</span><span class="st">"L200.ModelTime"</span>, <span class="st">"L200.ModelTimeInterYears"</span><span class="op">)</span> <span class="op">-&gt;</span></span>
<span><span class="va">modeltime.xml</span></span>
<span></span>
<span><span class="fu"><a href="../../reference/return_data.html">return_data</a></span><span class="op">(</span><span class="va">modeltime.xml</span><span class="op">)</span></span></code></pre></div>
<p>Let’s take a closer look at those XML pipeline helpers. Note that these functions are “exported” so users can use them to convert tibbles to XML for their own analysis done outside of the gcamdata package. You can check the documentation for them using the typicall R syntax: <code><a href="../../reference/create_xml.html">?create_xml</a></code>.</p>
<div class="section level3">
<h3 id="create_xml">create_xml<a class="anchor" aria-label="anchor" href="#create_xml"></a>
</h3>
<p>Creates the “XML” objects and typically a user only needs to provide the XML file name to save as.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' The basis to define how to convert data to an XML file.  This method</span></span>
<span><span class="co">#' simple requires the name to save the XML file as and optionally the</span></span>
<span><span class="co">#' model interface "header" file that defines the transformation lookup</span></span>
<span><span class="co">#' to go from tabular data to hierarchical.  The result of this should be</span></span>
<span><span class="co">#' used in a dplyr pipeline with one or more calls to \code{\link{add_xml_data}}</span></span>
<span><span class="co">#' to add the data to convert and finally ending with \code{\link{run_xml_conversion}}</span></span>
<span><span class="co">#' to run the conversion.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param xml_file The name to save the XML file to</span></span>
<span><span class="co">#' @param mi_header The model interface "header".  This will default to the one</span></span>
<span><span class="co">#' included in this package</span></span>
<span><span class="co">#' @return A "data structure" to hold the various parts needed to run the model</span></span>
<span><span class="co">#' interface CSV to XML conversion.</span></span>
<span><span class="co">#' @export</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="add_xml_data">add_xml_data<a class="anchor" aria-label="anchor" href="#add_xml_data"></a>
</h3>
<p>Adds a tibble to the XML started under <code>create_xml</code> which gets transformed using the “header” tag specified as the second argument. Note the order in which tibbles are added can be relevant so users should think carefully about that. Particularly if they need to use the functions <code>add_rename_landnode_xml</code> or <code>add_node_equiv_xml</code>. Also note that generally gcamdata does not enforce column ordering to match the old data system however the Model Interface will match “headers” by column ordering. Thus we have provided a database of <code>LEVEL2_DATA_NAMES</code>, which is equivalent to the <code>name_DepRsrc</code> etc in the old data system, to ensure columns in the correct order prior to XML conversion. The <code>add_xml_data</code> method will by default use the supplied header to look up the ordering from <code>LEVEL2_DATA_NAMES</code> and automatically reorder the columns for you. If you get an error message along the lines of <code>Error: Unknown columns selected</code> from this method it is likely that your columns are not matching up to the header. In such a case users can just ensure proper column ordering manually and pass <code>NULL</code> as the last argument to this function.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Add a table to include for conversion to XML.  We need the tibble to convert</span></span>
<span><span class="co">#' and a header tag which can be looked up in the header file to convert the</span></span>
<span><span class="co">#' tibble.  This method is meant to be included in a pipeline between calls of</span></span>
<span><span class="co">#' \code{\link{create_xml}} and \code{\link{run_xml_conversion}}.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param dot The current state of the pipeline started from \code{create_xml}</span></span>
<span><span class="co">#' @param data The tibble of data to add to the conversion</span></span>
<span><span class="co">#' @param header The header tag to can be looked up in the header file to</span></span>
<span><span class="co">#' convert \code{data}</span></span>
<span><span class="co">#' @param column_order_lookup A tag that can be used to look up \code{LEVEL2_DATA_NAMES}</span></span>
<span><span class="co">#' to reorder the columns of data before XML conversion to ensure the correspond</span></span>
<span><span class="co">#' with the ModelInterface header.  Note by default the \code{header} is used and if</span></span>
<span><span class="co">#' given \code{NULL} no column reordering will be done.</span></span>
<span><span class="co">#' @return A "data structure" to hold the various parts needed to run the model</span></span>
<span><span class="co">#' interface CSV to XML conversion.</span></span>
<span><span class="co">#' @author PP March 2017</span></span>
<span><span class="co">#' @export</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="run_xml_conversion">run_xml_conversion<a class="anchor" aria-label="anchor" href="#run_xml_conversion"></a>
</h3>
<p>Calls the Model Interface to convert tibbles to XML as defined through calls to <code>create_xml</code> and <code>add_xml_data</code>. Note that unlike the old data system all of the conversion will happen in memory instead of writing to disk CSV files and Batch XML files. As noted earlier the driver will only actually run the conversions if it is configured to do so.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Run the CSV to XML conversion using the model interface tool.  This method</span></span>
<span><span class="co">#' should be the final call in a pipeline started with \code{\link{create_xml}}</span></span>
<span><span class="co">#' and one or more calls to \code{\link{add_xml_data}}.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' Not that this method relies on Java to run the conversion.  To avoid errors for</span></span>
<span><span class="co">#' users who do not have Java installed it will check the global option</span></span>
<span><span class="co">#' \code{gcamdata.use_java} before attempting to run the conversion.  If the flag</span></span>
<span><span class="co">#' is set to \code{FALSE} a warning will be issued and the conversion skipped.</span></span>
<span><span class="co">#' To enable the use of Java a user can set \code{options(gcamdata.use_java=TRUE)}</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param dot The current state of the pipeline started from \code{create_xml}</span></span>
<span><span class="co">#' @return The argument passed in unmodified in case a user wanted run the</span></span>
<span><span class="co">#' conversion again at a later time.</span></span>
<span><span class="co">#' @author PP March 2017</span></span>
<span><span class="co">#' @export</span></span></code></pre></div>
<p>A couple of more specialized helper functions which may be required from time to time are also provided:</p>
</div>
<div class="section level3">
<h3 id="add_rename_landnode_xml">add_rename_landnode_xml<a class="anchor" aria-label="anchor" href="#add_rename_landnode_xml"></a>
</h3>
<p>Due to limitation in how the model interface converts tables [[Headers]] aribrary levels of nesting of the same tag needs to get numbered, i.e. LandNode1, LandNode2, etc, during processing and as a very last step renamed back, i.e. LandNode. This method does that for you.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Add a table to an XML pipeline that instructs the ModelInterface to rename</span></span>
<span><span class="co">#' LandNodeX to LandNode.  Such a table is necessary to help work around</span></span>
<span><span class="co">#' limitations in the XML processing that node names of the same name can not be</span></span>
<span><span class="co">#' nested with in each other: LandNode/LandNode thus instead we say</span></span>
<span><span class="co">#' LandNode1/LandNode2 and rename as the last step.  Therefore in most cases a</span></span>
<span><span class="co">#' user should add this table near the end of the XML pipeline.</span></span>
<span><span class="co">#' @param dot The current state of the pipeline started from \code{create_xml}</span></span>
<span><span class="co">#' @return A "data structure" to hold the various parts needed to run the model</span></span>
<span><span class="co">#' interface CSV to XML conversion.</span></span>
<span><span class="co">#' @author Pralit Patel</span></span>
<span><span class="co">#' @export</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="add_node_equiv_xml">add_node_equiv_xml<a class="anchor" aria-label="anchor" href="#add_node_equiv_xml"></a>
</h3>
<p>Sometimes it is handy to just read in one table to read in some parameter even though it might need to get set into XML nodes with different node names. For example <code>share-weight</code> into <code>technology</code> and <code>intermittent-technology</code>. This method defines “equivalence classes” which can allow the Model Interface to support such a thing.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Add a table to an XML pipeline that instructs the ModelInterface to treat</span></span>
<span><span class="co">#' tags in the same class as the same when enabled.  Thus not requiring multiple</span></span>
<span><span class="co">#' headers for instance to read in a share-weight into a technology</span></span>
<span><span class="co">#' intermittent-technology or tranTechnology.  A user taking advantage of this</span></span>
<span><span class="co">#' feature would then read this table early in the XML pipeline.</span></span>
<span><span class="co">#' @param dot The current state of the pipeline started from \code{create_xml}</span></span>
<span><span class="co">#' @param equiv_class A name of the equivalence class to add.  This could be any</span></span>
<span><span class="co">#' key in the list \code{XML_NODE_EQUIV}.</span></span>
<span><span class="co">#' @return A "data structure" to hold the various parts needed to run the model</span></span>
<span><span class="co">#' interface CSV to XML conversion.</span></span>
<span><span class="co">#' @author Pralit Patel</span></span>
<span><span class="co">#' @export</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="model-interface-headers">Model Interface Headers<a class="anchor" aria-label="anchor" href="#model-interface-headers"></a>
</h2>
<p>At the core of converting tabular data such as tibbles into XML is this home grown “header” language. It’s basic principal is to assign to each column of a table a <code>parent-node-name/child-node-name</code> relationship (Note they can get more complicated to specificy arbitrary grandparent relationships although such a feature is no longer actively used). In addition, you can add a <code>+</code> in the header such as <code>parent/+{specified=inline}child</code> to read a value out of the current row of the table being processed:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb7-1"><a href="#cb7-1"></a><span class="kw">&lt;parent&gt;</span></span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="kw">&lt;child</span><span class="ot"> specified=</span><span class="st">"inline"</span><span class="kw">&gt;</span>Value read from table<span class="kw">&lt;/child&gt;</span></span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="kw">&lt;/parent&gt;</span></span></code></pre></div>
<p>Or you can specify the <code>+</code> with an attribute and the value from the table will be read into that attribute <code>parent/+{name;specified=inline}child</code>:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb8-1"><a href="#cb8-1"></a><span class="kw">&lt;parent&gt;</span></span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="kw">&lt;child</span><span class="ot"> name=</span><span class="st">"Value read from table"</span><span class="ot"> specified=</span><span class="st">"inline"</span><span class="kw">&gt;&lt;/child&gt;</span></span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="kw">&lt;/parent&gt;</span></span></code></pre></div>
<p>Each column will get such a header (they do not necessarily have to read a value from the table using <code>+</code>) and any additional XML heirarchical relationship information will be specied at the end. Only one such definition will be specified with no parent and that will be used as the root of the XML. Thus the Model Interface will process each table row by row starting from the root and processing columns in parent / child relationship. The default database of Model Interface headers are found in the gcamdata package under <code>inst/extdata/mi_headers/ModelInterface_headers.txt</code>. Note that the first entry in each line is a look up “header” and is the tag specied as the second argument in <code>add_xml_data</code>.</p>
<pre><code>DepRsrc, world/+{name}region, region/+{name}depresource, depresource/+output-unit, depresource/+price-unit, depresource/+market, scenario, scenario/world</code></pre>
<p>When adding a new header you can update the default database <code>inst/extdata/mi_headers/ModelInterface_headers.txt</code> and give it a unique lookup of a sensible name. Since we can not expect the column order of tibbles to be in some expected order you will also need to update the <code>LEVEL2_DATA_NAMES</code> in <code>data-raw/level2_data_names.R</code>. Here you will have to update the list where the key is the same lookup in the header definition and the value is an array of column names in the order corresponding to your header.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">level2_data_names</span><span class="op">[[</span><span class="st">"DepRsrc"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="st">"region"</span>, <span class="st">"depresource"</span>, <span class="st">"output.unit"</span>, <span class="st">"price.unit"</span>, <span class="st">"market"</span> <span class="op">)</span></span></code></pre></div>
<p>Once this is done you should re-reun <code>data-raw/level2_data_names.R</code> to update the data loaded by the gcamdata package at runtime.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Russell Horowitz, Ben Bond-Lamberty, Katherine Calvin, Ryna Cui, Kalyn Dorheim, Leyang Feng, Jill Horing, Page Kyle, Robert Link, Pralit Patel, Christopher Roney, Abigail Snyder, Aaron Staniszweski, Sean Turner, Matthew Binsted, Zarrar Khan.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
